Segment Routing MPLS data plane Clarence Filsfils Kris Michielsen Segment Routing MPLS data plane Segment Routing leverages existing MPLS data plane How to verify Segment Routing MPLS forwarding 2014 Cisco and or its affiliates. All rights reserved. 2 Segment Routing MPLS Data Plane 2014 Cisco and or its affiliates. All rights reserved. 3 MPLS Data Plane Operations Segment Routing uses the existing MPLS data plane Segment label Segment list label stack Uses Penultimate Hop Popping (PHP) and Explicit-Null functionalities Default PHP is enabled Explicit-Null label can be enabled if needed 2014 Cisco and or its affiliates. All rights reserved. 4 MPLS Data Plane Operations A node imposes a prefix-SID label on a packet if The destination itself or the next-hop that the destination resolves on matches a FEC with a Prefix-SID The downstream neighbor is SR enabled The node is configured to prefer SR label imposition or the matching FEC (see above) does not have an associated LDP label 2014 Cisco and or its affiliates. All rights reserved. 5 MPLS Data Plane Operations 1 2 Push Swap Segment 16004 3 Pop 4 - Payload 16004 Payload 16004 Payload Payload 1.1.1.4 32 Prefix-SID 16004 or 2001 0101 0104 128 Prefix-SID 16004 NP-flag 0 E-flag 0 Assumptions SR enabled on all nodes LDP not enabled on Node1 Node4 advertises its loopback ipv4 prefix 1.1.1.4 32 with attached prefix-SID 16004 Or node4 advertises ipv6 prefix 2001 0101 0104 128 with attached prefix-SID 16004 Node4 requests the default PHP functionality (noPHP-flag 0 ExpNull-flag 0) 2014 Cisco and or its affiliates. All rights reserved. 6 MPLS Data Plane Operations push label 1 2 Push Swap Segment 16004 3 Pop Prefix-SID 16004 NP-flag 0 E-flag 0 4 - FIB entry remote prefix P with prefix-SID N operation egress interface oif spt(N) push N Payload 16004 Payload 16004 Payload Payload RP 0 0 CPU0 Node1 show cef 1.1.1.4 32 1.1.1.4 32 version 277 internal 0x4004001 0x0 (ptr 0xacce39a4) 1 0x0 (0xaccde760) 0x450 (0xacd8b8) local adjacency 10.0.0.2 Prefix Len 32 traffic index 0 precedence n a priority 1 via 99.1.2.2 GigabitEthernet0 0 0 0 5 dependencies weight 0 class 0 flags 0x0 path-idx 0 NHID 0x0 0xacbb3bf0 0x0 next hop 99.1.2.2 local adjacency local label 16004 labels imposed 16004 2014 Cisco and or its affiliates. All rights reserved. 7 MPLS Data Plane Operations push label 1 2 Push Swap Segment 16004 3 Pop Prefix-SID 16004 NP-flag 0 E-flag 0 4 - FIB entry remote prefix P with prefix-SID N operation egress interface oif spt(N) push N Payload 16004 Payload 16004 Payload Payload RP 0 0 CPU0 Node1 show cef ipv6 2001 0101 0104 128 2001 101 104 128 version 809 internal 0x1000001 0x1 (ptr 0xa138ad74) 1 0x0 (0xa1355878) 0xa28 (0xa14db3c0) local adjacency fe80 f816 3eff fe01 7de8 Prefix Len 128 traffic index 0 precedence n a priority 15 via fe80 f816 3eff fe01 7de8 GigabitEthernet0 0 0 0 7 dependencies weight 0 class 0 flags 0x0 path-idx 0 NHID 0x20009 0xa0c8e7c4 0x0 next hop fe80 f816 3eff fe01 7de8 local adjacency local label 16004 labels imposed 16004 2014 Cisco and or its affiliates. All rights reserved. 8 MPLS Data Plane Operations swap label 1 2 Push Swap Segment 16004 3 Pop 4 - Payload 16004 Payload 16004 Payload Payload Prefix-SID 16004 NP-flag 0 E-flag 0 LFIB entry remote prefix-SID of value N ingress label N operation swap egress intf oif spt(N) RP 0 0 CPU0 Node2 show mpls forwarding labels 16004 Local Outgoing Prefix Outgoing Next Hop Bytes Label Label or ID Interface Switched ------ ----------- ------------------ ------------ --------------- ------------ 16004 16004 SR Pfx (idx 4) Gi0 0 0 1 99.2.3.3 0 2014 Cisco and or its affiliates. All rights reserved. 9 MPLS Data Plane Operations pop label 1 2 Push Swap Segment 16004 3 Pop 4 - Payload 16004 Payload 16004 Payload Payload Prefix-SID 16004 NP-flag 0 E-flag 0 LFIB entry remote prefix-SID of value N (penultimate hop PHP on ExpNull off) ingress label N operation pop egress intf oif spt(N) RP 0 0 CPU0 Node3 show mpls forwarding labels 16004 Local Outgoing Prefix Outgoing Next Hop Bytes Label Label or ID Interface Switched ------ ----------- ------------------ ------------ --------------- ------------ 16004 Pop SR Pfx (idx 4) Gi0 0 0 1 99.3.4.4 0 2014 Cisco and or its affiliates. All rights reserved. 10 MPLS Data Plane Operations 1 2 Push Swap Segment 16004 3 Pop Prefix-SID 16004 NP-flag 0 E-flag 0 4 Payload 16004 Payload 16004 Payload Payload - Packet arrives without SID label forwarding based on ip address or service label 2014 Cisco and or its affiliates. All rights reserved. 11 MPLS Data Plane Operations Explicit-Null Explicit-Null behavior is configurable for a prefix-SID If the originator of a Prefix-SID wants to receive the packet with the original EXP TC bits (e.g. QoS pipe model) he can set the E-flag in the Prefix-SID. This causes the penultimate-hop to swap the prefix-SID with explicit-null (hence preserving the EXP TC) instead of popping the Prefix-SID To set the E-flag on a locally originated Prefix-SID router isis 1 interface Loopback0 address-family ipv4 unicast prefix-sid absolute 16001 explicit-null See SR IGP Control Plane slides for more info 2014 Cisco and or its affiliates. All rights reserved. 12 MPLS Data Plane Operations Explicit-Null Segment 16004 1 2 3 Push Swap Swap 4 - Payload 16004 Payload 16004 Payload Exp-Null Payload Prefix-SID 16004 NP-flag 1 E-flag 1 LFIB entry remote prefix-SID of value N (penultimate hop Explicit-Null) ingress label N operation swap with Exp-Null egress intf oif spt(N) RP 0 0 CPU0 Node3 show mpls forwarding labels 16004 Local Outgoing Prefix Outgoing Next Hop Bytes Label Label or ID Interface Switched ------ ----------- ------------------ ------------ --------------- ------------ 16004 Exp-Null-v4 SR Pfx (idx 4) Gi0 0 0 1 99.3.4.4 0 2014 Cisco and or its affiliates. All rights reserved. 13 MPLS Data Plane Operations Explicit-Null label Segment 16004 1 2 3 Push Swap Swap 4 - Payload 16004 Payload 16004 Payload Exp-Null Payload Prefix-SID 16004 NP-flag 1 E-flag 1 LFIB entry remote prefix-SID of value N (penultimate hop Explicit-Null) ingress label N operation swap with Exp-Null egress intf oif spt(N) RP 0 0 CPU0 Node3 show mpls forwarding labels 16004 Local Outgoing Prefix Outgoing Next Hop Bytes Label Label or ID Interface Switched ------ ----------- ------------------ ------------ --------------- ------------ 16004 Exp-Null-v6 SR Pfx (idx 4) Gi0 0 0 0 fe80 f816 3eff fe1d 384a \ 0 2014 Cisco and or its affiliates. All rights reserved. 14 Simple and Efficient Transport of MPLS services MPLS services ride on the prefix segments Simple one less protocol to operate (LDP) CE 7 CE 8 MP-BGP PE PE 1 3 4 2 5 6 1.1.1.2 32 Prefix-SID 16002 10.0.0.0 30 2001 a00 0 126 vrf RED SR Domain vrf RED 2014 Cisco and or its affiliates. All rights reserved. 15 Verifying IP Forwarding (global table) RP 0 0 CPU0 xrvr-1 show cef 1.1.1.2 32 1.1.1.2 32 version 652 internal 0x4004001 0x0 (ptr 0xacca7ba4) 2 0x0 (0xacca27a8) 0x450 (0xacfd1c10) Updated Jan 28 09 00 55.333 local adjacency 99.1.3.3 Prefix Len 32 traffic index 0 precedence n a priority 1 via 99.1.3.3 GigabitEthernet0 0 0 0 8 dependencies weight 0 class 0 flags 0x0 path-idx 0 NHID 0x0 0xacbbaeac 0x0 next hop 99.1.3.3 local adjacency local label 16002 labels imposed 16002 via 99.1.5.5 GigabitEthernet0 0 0 1 8 dependencies weight 0 class 0 flags 0x0 path-idx 1 NHID 0x0 0xacbbac54 0x0 next hop 99.1.5.5 local adjacency local label 16002 labels imposed 16002 Global prefix 2 paths (ECMP) Push label stack Label stack Prefix-SID Prefix-SID 2014 Cisco and or its affiliates. All rights reserved. 16 Verifying IP Forwarding (VRF RED) RP 0 0 CPU0 xrvr-1 show cef vrf RED 10.0.0.0 30 10.0.0.0 30 version 27 internal 0x14004001 0x0 (ptr 0xacca79a4) 1 0x0 (0x0) 0x410 (0xacd3372c) Updated Jan 27 10 05 33.906 Prefix Len 30 traffic index 0 precedence n a priority 3 via 1.1.1.2 5 dependencies recursive flags 0x6000 path-idx 0 NHID 0x0 0xacfc0e24 0x0 next hop VRF - default table - 0xe0000000 next hop 1.1.1.2 via 16002 0 21 next hop 99.1.3.3 32 Gi0 0 0 0 labels imposed 16002 90001 next hop 99.1.6.6 32 Gi0 0 0 1 labels imposed 16002 90001 VPN prefix (VRF RED) BGP nexthop egress PE 2 paths (ECMP) Push label stack Prefix-SID to egress PE BGP VPN label 2014 Cisco and or its affiliates. All rights reserved. 17 Verifying MPLS Forwarding RP 0 0 CPU0 xrvr-3 show mpls forwarding Local Outgoing Prefix Outgoing Next Hop Bytes Label Label or ID Interface Switched ------ ----------- ------------------ ------------ --------------- ------------ 16001 16001 SR Pfx (idx 1) Gi0 0 0 0 99.2.3.2 0 16002 Exp-Null-v4 SR Pfx (idx 2) Gi0 0 0 0 99.2.3.2 0 16004 Pop SR Pfx (idx 4) Gi0 0 0 1 99.3.4.4 0 16005 16005 SR Pfx (idx 5) Gi0 0 0 1 99.3.4.4 0 16010 16010 SR Pfx (idx 10) Gi0 0 0 0 99.2.3.2 0 16010 SR Pfx (idx 10) Gi0 0 0 1 99.3.4.4 0 24032 Pop SR Adj (idx 1) Gi0 0 0 0 99.2.3.2 0 24034 Pop SR Adj (idx 3) Gi0 0 0 1 99.3.4.4 0 3 Gi0 0 0 0 G i 0 0 0 1 4 Node n advertises prefix-SID 16000+n prefix-SIDs of remote nodes adjacency-SIDs 2 5 1 10 2014 Cisco and or its affiliates. All rights reserved. 18 Verifying MPLS Forwarding RP 0 0 CPU0 xrvr-3 show mpls forwarding Local Outgoing Prefix Outgoing Next Hop Bytes Label Label or ID Interface Switched ------ ----------- ------------------ ------------ --------------- ------------ 16001 16001 SR Pfx (idx 1) Gi0 0 0 0 99.2.3.2 0 16002 Exp-Null-v4 SR Pfx (idx 2) Gi0 0 0 0 99.2.3.2 0 16004 Pop SR Pfx (idx 4) Gi0 0 0 1 99.3.4.4 0 16005 16005 SR Pfx (idx 5) Gi0 0 0 1 99.3.4.4 0 16010 16010 SR Pfx (idx 10) Gi0 0 0 0 99.2.3.2 0 16010 SR Pfx (idx 10) Gi0 0 0 1 99.3.4.4 0 24032 Pop SR Adj (idx 1) Gi0 0 0 0 99.2.3.2 0 24034 Pop SR Adj (idx 3) Gi0 0 0 1 99.3.4.4 0 3 Gi0 0 0 0 G i 0 0 0 1 4 Node n advertises prefix-SID 16000+n Remote prefix-SID Neighbor prefix-SID Explicit-Null Neighbor prefix-SID PHP on Remote prefix-SIDs ECMP 2 5 1 10 2014 Cisco and or its affiliates. All rights reserved. 19 Visit us cisco.com segment-routing.net Acknowledgements Ahmed Bashandy Robert Hanzl Jose Liste Steven Luong Stefano Previdi Peter Psenak Thank you. 