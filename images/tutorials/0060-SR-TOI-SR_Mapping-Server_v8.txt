Segment Routing Mapping Server Clarence Filsfils Kris Michielsen Segment Routing Mapping Server Objective of the Mapping Server Configuring the Mapping Server Verifying the Mapping Server functionality 2015 Cisco and or its affiliates. All rights reserved. 2 Mapping Server 2015 Cisco and or its affiliates. All rights reserved. 3 Mapping Server Functionality Advertise Prefix-to-SID mappings in IGP on behalf of other non-SR-capable nodes prefix-to-sid mappings are configured on the Mapping Server Enable SR-capable nodes to interwork with (non-SR- capable) LDP nodes a Mapping Server is required for SR LDP interworking See the SR LDP interworking section for more information 2015 Cisco and or its affiliates. All rights reserved. 4 Mapping Server Functionality Position of mapping server is comparable to a BGP Route- reflector Mapping server is a control plane mechanism Mapping server doesn t have to be in the data path Mapping server must be resilient redundancy should be provided 2015 Cisco and or its affiliates. All rights reserved. 5 Mapping Client Functionality Mapping Client functionality Receive and parse prefix-to-sid mappings from Mapping Server(s) Use remotely learnt and locally configured mapping entries to construct a valid and consistent Active SID Mapping policy Mappings that are not selected for the Active policy go to the Backup policy IGP instance uses the Active SID Mapping policy to (re-)calculate the prefix-SID of some or all prefixes 2015 Cisco and or its affiliates. All rights reserved. 6 Mapping Client Functionality Common-sense design rule If a mapping server is used all nodes should be mapping client to receive the prefix-to-sid mappings that they would not otherwise receive via the link-state advertisement from the non-SR nodes 2015 Cisco and or its affiliates. All rights reserved. 7 Mapping Server Architecture Local Policy Verifier Policy Calculator s e i r t n e RIB Worker Prefix-SID lookups Active Policy Configuration i g n p p a m l a c o L i g n p p a M m o r f r e g a n a M Backup Policy Local Policy Cached Local Policy Mapping Manager IGP Local policy LSP LSA Parsing LSP LSA Generation From other nodes To other nodes 2015 Cisco and or its affiliates. All rights reserved. 8 Q Can I use Mapping Server for centralized SID advertisement A No A Mapping Server is intended for advertising prefix-to-SID mappings for non-SR-capable nodes Prefix-SIDs received from a Mapping Server have an implicit PHP-off behavior the penultimate hop will not pop the prefix-SID label packets will arrive at the destination with prefix-SID label on top packet with local prefix-SID as top label would require two label lookups at the receiving node to forward packet top-label lookup pop top-label next-label or address lookup performance impact In IOS XR no mpls forwarding entry is installed for local prefix-SIDs packets with local prefix-SID as top label are dropped 2015 Cisco and or its affiliates. All rights reserved. 9 Q Can I use Mapping Server for centralized SID advertisement A No OSPF partially removes this limitation for intra-area prefixes If the intra-area prefix is local to the nexthop router then OSPF will pop the label even if the prefix-SID is received from the mapping server 2015 Cisco and or its affiliates. All rights reserved. 10 Mapping Server and multi-area multi-level networks IS-IS Mapping server advertisements are currently not propagated between levels a mapping server is required per IS-IS area OSPF Mapping server advertisements are propagated between areas 2015 Cisco and or its affiliates. All rights reserved. 11 Mapping Server Configuration 2015 Cisco and or its affiliates. All rights reserved. 12 Mapping Server Configuration segment-routing mapping-server prefix-sid-map address-family ipv4 ipv6 prefix mask first-SID-value range range ... Each line under prefix-sid-map maps to a prefix-to-sid mapping advertisement 2015 Cisco and or its affiliates. All rights reserved. 13 Mapping Server Routing Protocol CLI router isis 1 address-family ipv4 ipv6 unicast segment-routing prefix-sid-map advertise-local router ospf 1 segment-routing prefix-sid-map advertise-local advertise-local IGP advertises locally configured prefix-SID mappings receive enabled by default for newer releases See client functionality slide Mappings are advertised in all levels areas on L1L2 IS-IS router and OSPF ABR 2015 Cisco and or its affiliates. All rights reserved. 14 Configuration Example Mapping Server segment-routing mapping-server prefix-sid-map address-family ipv4 prefix len 1st-SID range range 10.1.1.1 32 10 range 200 20.1.1.0 24 400 range 300 router isis 1 address-family ipv4 unicast segment-routing prefix-sid-map advertise-local Typical Mapping Server configuration 20.1.1.0 24 prefix-SID idx 400 20.1.2.0 24 prefix-SID idx 401 ... 20.2.44.0 24 prefix-SID idx 699 10.1.1.1 32 prefix-SID idx 10 10.1.1.2 32 prefix-SID idx 11 ... 10.1.1.200 32 prefix-SID idx 209 advertise-local command Note older releases don t have the required client functionality enabled by default See mapping server client slide 2015 Cisco and or its affiliates. All rights reserved. 15 Configuration Example Mapping Client Typical Mapping Client configuration no local SID mapping configured no advertise-local command receive functionality enabled by default Mapping client functionality can be disabled router isis 1 address-family ipv4 ipv6 unicast segment-routing prefix-sid-map receive default router ospf 1 segment-routing prefix-sid-map receive default 2015 Cisco and or its affiliates. All rights reserved. 16 no Overview Mapping Server Config Options Advertise local policy Compute Active Policy Configuration option receive (default) Ignore local mappings Use remote mappings advertise-local Use local mappings + receive disable Ignore remote mappings receive Use local mappings + advertise-local Use remote mappings Compute Active Policy which mappings are used in the Active Mapping Policy calculation Local mappings locally configured mappings Remote mappings mappings received from remote Mapping Servers yes yes 2015 Cisco and or its affiliates. All rights reserved. 17 Verifying locally configured prefix-to-SID mappings Locally configured mappings Locally configured mappings RP 0 0 CPU0 xrvr-3 show segment-routing mapping-server prefix-sid-map ipv4 Prefix SID Index Range Flags 20.1.1.0 24 400 300 10.1.1.1 32 10 200 Number of mapping entries 2 RP 0 0 CPU0 xrvr-3 show segment-routing mapping-server prefix-sid-map ipv4 detail Prefix 20.1.1.0 24 SID Index 400 Range 300 Last Prefix 20.2.44.0 24 Last SID Index 699 Flags 10.1.1.1 32 SID Index 10 Range 200 Last Prefix 10.1.1.200 32 Last SID Index 209 Flags Number of mapping entries 2 2015 Cisco and or its affiliates. All rights reserved. 18 Mapping Server Advertisements 2015 Cisco and or its affiliates. All rights reserved. 19 IS-IS Mapping Server Advertisements IS-IS advertises prefix-to-SID mappings in the SID Label Binding TLV The prefix-SID sub-TLV can be a sub-TLV of this TLV Each block of prefix-to-SID mappings is encoded in a separate TLV 2015 Cisco and or its affiliates. All rights reserved. 20 Verifying prefix-to-SID mappings advertisement IS-IS RP 0 0 CPU0 xrvr-2 show isis database verbose xrvr-3.00-00 IS-IS 1 (Level-2) Link State Database LSPID LSP Seq Num LSP Checksum LSP Holdtime ATT P OL xrvr-3.00-00 0x00000195 0x5614 617 0 0 0 ...removed... SID Binding 10.1.1.1 32 F 0 M 0 S 0 D 0 A 0 Weight 0 Range 200 SID Start 10 Algorithm 0 R 0 N 0 P 0 E 0 V 0 L 0 SID Binding 20.1.1.0 24 F 0 M 0 S 0 D 0 A 0 Weight 0 Range 300 SID Start 400 Algorithm 0 R 0 N 0 P 0 E 0 V 0 L 0 Prefix-to-SID mapping TLV Flag F 0 IPv4 2015 Cisco and or its affiliates. All rights reserved. 21 IS-IS SID Label Binding TLV flags IS-IS SID Label Binding TLV has the following flags 0 1 2 3 4 5 6 7 +-+-+-+-+-+-+-+-+ F M S D A +-+-+-+-+-+-+-+-+ F Address-Family unset IPv4 set IPv6 M Mirror Context set if the SID path corresponds to a mirrored context S Scope if unset then TLV must not be propagated between leveks D Down set if TLV is leaked from Level-2 to Level-1 A Attached set if prefixes and SIDs are directly connected to their originator 2015 Cisco and or its affiliates. All rights reserved. 22 IS-IS Prefix-SID in MS TLV flags IS-IS Prefix-SID sub-TLV in the SID Label Binding TLV may only use the N-flag 0 1 2 3 4 5 6 7 +-+-+-+-+-+-+-+-+ - N - - - - +-+-+-+-+-+-+-+-+ N Node-SID set if the prefix-SID is a node-SID i.e. identifies the node 2015 Cisco and or its affiliates. All rights reserved. 23 OSPF Mapping Server Advertisements OSPF advertises prefix-to-SID mappings in a Extended Prefix (type 7) Opaque LSAs In the Extended Prefix Opaque LSA the prefix-to-sid mappings are encoded in OSPF Extended Prefix Range TLV The prefix-SID sub-TLV can be a sub-TLV of this TLV 2015 Cisco and or its affiliates. All rights reserved. 24 Verifying prefix-to-SID mappings advertisement OSPF RP 0 0 CPU0 xrvr-3 show ospf database opaque-area self-originate ... LS age 910 Options (No TOS-capability DC) LS Type Opaque Area Link Link State ID 7.0.0.5 Opaque Type 7 Opaque ID 5 Advertising Router 1.1.1.3 LS Seq Number 80000001 Checksum 0x7f0e Length 48 Extended Prefix Range TLV Length 24 AF 0 Prefix 10.1.1.1 32 Range Size 200 Flags 0x0 SID sub-TLV Length 8 Flags 0x60 MTID 0 Algo 0 SID Index 10 Prefix-to-SID mapping 2015 Cisco and or its affiliates. All rights reserved. 25 OSPF Extended Prefix Range TLV flags OSPF Extended Prefix Range TLVs have the following flags 0 1 2 3 4 5 6 7 +--+--+--+--+--+--+--+--+ IA +--+--+--+--+--+--+--+--+ IA Inter-Area set if advertisement is of inter-area type used to prevent redundant flooding between areas 2015 Cisco and or its affiliates. All rights reserved. 26 OSPF Prefix-SID sub-TLV flags OSPF Prefix-SID sub-TLVs have the following flags 0 1 2 3 4 5 6 7 +--+--+--+--+--+--+--+--+ NP M E V L +--+--+--+--+--+--+--+--+ NP no-PHP set if the penultimate hop must NOT pop the prefix-SID before forwarding the packet M Mapping Server set if the SID is advertised from the Mapping Server functionality E Explicit-Null set if penultimate hop must replace prefix-SID with Explicit-Null label V Value set if prefix-SID carries a value (not an index) IOS XR always unset L Local set if prefix-SID has local significance IOS XR always unset 2015 Cisco and or its affiliates. All rights reserved. 27 Multiple Mapping Servers 2015 Cisco and or its affiliates. All rights reserved. 28 Multiple Mapping Servers Two or more mapping servers advertise a set of prefix-SID mappings It is expected that these sets are equal for all mapping servers If not a set of non-overlapping entries is selected as Active Policy Other mapping entries end up in the Backup Policy Consistent prefix-SID mapping required throughout the network The Active Policy is guaranteed to be the same on all nodes receiving the mappings 2015 Cisco and or its affiliates. All rights reserved. 29 Mapping entry preference If a Mapping Client receives two or more overlapping mapping ranges it selects one of the ranges based on these preference rules 1. Largest router-id (OSPF) or system-id (ISIS) is preferred 2. Smallest area-id (OSPF) or level (ISIS) is preferred 3. 4. Smallest prefix length is preferred 5. Smallest IP address is preferred 6. Smallest SID index is preferred 7. Smallest range is preferred 8. First received range is preferred IPv4 range is preferred over IPv6 range This will change in the future based on the evolution of the draft-ietf- spring-conflict-resolution at the IETF 2015 Cisco and or its affiliates. All rights reserved. 30 segment-routing segment-routing mapping-server mapping-server prefix-sid-map prefix-sid-map address-family ipv4 address-family ipv4 1.1.1.100 32 100 range 20 1.1.1.100 32 100 range 20 1.1.1.150 32 150 range 10 1.1.1.150 32 150 range 10 Multiple Mapping Servers Example Two mapping servers (node2 and node3) advertise a set of prefix- SID mappings Mapping client (node1) receives the mappings from both mapping servers Mapping client selects a non- overlapping set as Active Policy Based on largest OSPF router-id or Mapping Server Mapping Client 1 2 ISIS system-id in this example 3 Mapping Server 2015 Cisco and or its affiliates. All rights reserved. 31 Verifying active and backup prefix-to-SID mappings IS-IS RP 0 0 CPU0 xrvr-1 sh isis segment-routing prefix-sid-map active-policy IS-IS 1 active policy Prefix SID Index Range Flags 1.1.1.100 32 100 20 1.1.1.150 32 150 10 Number of mapping entries 2 RP 0 0 CPU0 xrvr-1 sh isis segment-routing prefix-sid-map backup-policy IS-IS 1 backup policy Prefix SID Index Range Flags 1.1.1.100 32 100 20 1.1.1.150 32 150 10 Number of mapping entries 2 Backup mapping policy Active mapping policy 2015 Cisco and or its affiliates. All rights reserved. 32 Verifying active and backup prefix-to-SID mappings OSPF RP 0 0 CPU0 xrvr-1 sh ospf segment-routing prefix-sid-map active-policy SRMS active policy for Process ID 1 Prefix SID Index Range Flags 1.1.1.100 32 100 20 1.1.1.150 32 150 10 Number of mapping entries 2 RP 0 0 CPU0 xrvr-1 sh ospf segment-routing prefix-sid-map backup-policy SRMS backup policy for Process ID 1 Prefix SID Index Range Flags 1.1.1.100 32 100 20 1.1.1.150 32 150 10 Number of mapping entries 2 Backup mapping policy Active mapping policy 2015 Cisco and or its affiliates. All rights reserved. 33 Prefix-SID Preference 2015 Cisco and or its affiliates. All rights reserved. 34 Using which Prefix-SID The prefix-SID received via a regular advertisement is preferred IS-IS Prefix-SID sub TLV OSPF Extended Prefix Opaque LSA The prefix-SID advertised by a mapping server is used as a last resort If no regular prefix-SID is available for a prefix 2015 Cisco and or its affiliates. All rights reserved. 35 Visit us cisco.com segment-routing.net Acknowledgements Ahmed Bashandy Robert Hanzl Steven Luong Stefano Previdi Peter Psenak Thank you. 